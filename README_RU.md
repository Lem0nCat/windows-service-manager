# Скрипты для управления службами Windows

Набор batch-скриптов для автоматического и ручного управления службами Windows. Идеально подходит для приложений, требующих работы определенных служб только при необходимости. Включает инструменты для установки на уровне системы и управления.

По умолчанию работает для Check Point Endpoint Security VPN. Так цель проекта было отключение служб после завершения работы этого ПО.

## Возможности

- **Автоматическое управление службами**: Мониторинг процессов и автоматический запуск/остановка служб
- **Ручное управление службами**: Быстрые скрипты для ручного управления
- **Системная установка**: Установка менеджера служб как задачи автозапуска Windows
- **Мониторинг состояния**: Комплексная проверка статуса и диагностика
- **Универсальная конфигурация**: Поддержка любого количества служб
- **Надежная обработка ошибок**: Проверка прав администратора и валидация служб
- **Детальное логирование**: Логи с временными метками и разными уровнями детализации
- **Гибкая настройка**: Легко изменяемые конфигурационные разделы

## Включенные скрипты

### Основное управление службами
1. **`service_manager.bat`** - Автоматический монитор служб
   - Мониторит указанный процесс и управляет службами на основе его состояния

2. **`start_services.bat`** - Ручной запуск служб
   - Запускает указанные службы с опциями конфигурации

3. **`stop_services.bat`** - Ручная остановка служб
   - Останавливает указанные службы с защитными функциями

### Системная установка и управление
4. **`install_service.bat`** - Системная установка
   - Устанавливает service_manager.bat как задачу автозапуска Windows
   - Использует Планировщик задач для надежного выполнения на уровне системы
   - Настраивает привилегии SYSTEM и поведение при автозапуске

5. **`uninstall_service.bat`** - Удаление из системы
   - Удаляет все конфигурации автозапуска
   - Очищает запланированные задачи и записи реестра
   - Безопасно останавливает работающие процессы

6. **`check_service_status.bat`** - Проверка статуса
   - Комплексная верификация состояния
   - Проверяет наличие файлов, запланированных задач, записей реестра
   - Предоставляет команды управления и информацию для диагностики

## Установка

### Быстрая настройка
1. Скачайте или клонируйте репозиторий
2. Поместите все batch-файлы в нужную директорию
3. Запустите `install_service.bat` для установки автозапуска на уровне системы

### Ручная настройка
1. Скачайте нужные скрипты
2. Настройте скрипты управления службами
3. Запускайте нужные файлы вручную

## Конфигурация

### Базовая настройка

Отредактируйте раздел конфигурации в начале скриптов:

```batch
:: КОНФИГУРАЦИЯ
set "PROCESS_NAME=YourProcess.exe"
set "SERVICES=Service1 Service2 Service3"
set "CHECK_INTERVAL=10"
set "SERVICE_STARTUP_TYPE=delayed-auto"
set "VERBOSE_MODE=1"
```

### Параметры конфигурации

| Параметр | Описание | Допустимые значения |
|-----------|-------------|---------|
| `PROCESS_NAME` | Процесс для мониторинга (только для service_manager.bat) | Любое имя .exe файла |
| `SERVICES` | Список имен служб через пробел | Имена служб Windows |
| `CHECK_INTERVAL` | Интервал проверки в секундах | Любое положительное целое число |
| `SERVICE_STARTUP_TYPE` | Тип запуска службы | `auto`, `delayed-auto`, `demand`, `disabled` |
| `VERBOSE_MODE` | Детальное логирование | `0` (минимальное), `1` (подробное) |

## Использование

### Установка на уровне системы

```cmd
# Установить как задачу автозапуска Windows
install_service.bat

# Проверить статус установки
check_service_status.bat

# Удалить из системы
uninstall_service.bat
```

### Автоматическое управление службами

```cmd
# Запустить скрипт (или установить системно)
service_manager.bat
```

**Функционал:**
- Постоянно мониторит указанный процесс
- Запускает службы при обнаружении процесса
- Останавливает службы при завершении процесса
- Настраивает типы запуска служб
- Предоставляет обновления статуса в реальном времени

### Ручное управление службами

#### Запуск служб
```cmd
# Запустить скрипт
start_services.bat
```

#### Остановка служб
```cmd
# Запустить скрипт
stop_services.bat
```

## Детали системной установки

### Метод установки
Для лучшей совместимости используется **Планировщик задач Windows** вместо служб:

- **Основной**: Запланированная задача при запуске системы
- **Резервный**: Запись автозапуска в реестре
- **Привилегии**: Доступ уровня SYSTEM
- **Фоновый режим**: Работает без видимых окон
- **Надежность**: Нет ошибок таймаута служб

### Команды управления
После установки используйте команды:

```cmd
# Ручной запуск
schtasks /run /tn "ServiceManagerAutorun"

# Отключить/Включить
schtasks /change /tn "ServiceManagerAutorun" /disable
schtasks /change /tn "ServiceManagerAutorun" /enable

# Просмотр деталей
schtasks /query /tn "ServiceManagerAutorun" /fo list /v

# Управление через GUI
taskschd.msc
```

### Проверка статуса
Скрипт проверки предоставляет полную информацию:

- **Статус файлов**: Проверяет наличие service_manager.bat и показывает детали
- **Статус задач**: Проверяет установку запланированной задачи и статус выполнения
- **Статус реестра**: Валидирует записи автозапуска в реестре

## Примеры

### Пример 1: Приложение для баз данных
Мониторинг GUI базы данных и управление связанными службами:

```batch
set "PROCESS_NAME=DatabaseGUI.exe"
set "SERVICES=MSSQLSERVER SQLSERVERAGENT"
set "CHECK_INTERVAL=5"
```

### Пример 2: Среда разработки
Управление несколькими службами разработки:

```batch
set "PROCESS_NAME=VisualStudio.exe"
set "SERVICES=Docker IIS W3SVC MSSQLSERVER Redis"
set "CHECK_INTERVAL=15"
```

### Пример 3: Игровая настройка
Управление игровыми службами:

```batch
set "PROCESS_NAME=GameLauncher.exe"
set "SERVICES=SteamService EpicGamesLauncher"
set "CHECK_INTERVAL=10"
```

## Расширенная конфигурация

### Типы запуска служб

| Тип | Описание |
|------|-------------|
| `auto` | Автоматический запуск при загрузке |
| `delayed-auto` | Автоматический запуск с задержкой |
| `demand` | Ручной запуск при необходимости |
| `disabled` | Блокировка запуска службы |

### Скрипт-специфичные опции

#### service_manager.bat
```batch
set "CHECK_INTERVAL=10"        # Частота проверки процесса (секунды)
set "VERBOSE_MODE=1"           # Показывать детальные сообщения
```

#### start_services.bat
```batch
set "CONFIGURE_SERVICES=1"     # Настроить тип запуска перед стартом
set "WAIT_FOR_STARTUP=1"       # Ожидать полного запуска служб
```

#### stop_services.bat
```batch
set "FORCE_STOP=1"             # Принудительная остановка зависших служб
set "SET_TO_MANUAL=1"          # Перевести службы в ручной режим после остановки
set "REQUIRE_CONFIRMATION=1"   # Запрашивать подтверждение перед остановкой
```

## Уровни логирования

Скрипты поддерживают разные уровни логирования:

- **INFO**: Общие информационные сообщения
- **ACTION**: Действия запуска/остановки служб
- **SUCCESS**: Успешные операции
- **ERROR**: Сообщения об ошибках и сбоях
- **CONFIG**: Изменения конфигурации
- **DEBUG**: Детальная отладочная информация (только в подробном режиме)
- **WARNING**: Предупреждения
- **STATUS**: Отчеты о состоянии служб

## Требования

- **ОС Windows**: Windows 7/8/10/11 или Windows Server
- **Права администратора**: Требуются для управления службами и системной установки
- **Корректные имена служб**: Службы должны существовать в Windows Services
- **Планировщик задач**: Требуется для системной установки

## Диагностика проблем

### Распространенные проблемы

**Скрипт требует прав администратора**
- Скрипт автоматически запросит права администратора
- Через PowerShell: Запустите PowerShell от имени Администратора

**Ошибка "Служба не найдена"**
- Проверьте имена служб в services.msc
- Убедитесь в правильности написания имен
- Используйте точные имена служб, а не отображаемые имена

**Процесс не обнаруживается**
- Убедитесь, что имя процесса включает расширение .exe
- Проверьте имя процесса в Диспетчере задач
- Убедитесь, что процесс запущен при тестировании

**Службы не запускаются/останавливаются**
- Проверьте зависимости служб
- Убедитесь, что служба не отключена
- Проверьте Журнал событий Windows

**Проблемы установки**
- Убедитесь, что все файлы в одной директории
- Проверьте наличие service_manager.bat перед установкой
- Проверьте созданные задачи в Планировщике задач

### Режим отладки

Включите подробное логирование для диагностики:

```batch
set "VERBOSE_MODE=1"
```

Используйте `check_service_status.bat` для комплексной диагностики.

## Кастомизация

### Добавление новых служб

Просто добавьте имена служб в переменную SERVICES:

```batch
set "SERVICES=Service1 Service2 NewService AnotherService"
```

### Изменение интервалов проверки

Настройте под свои нужды:

```batch
set "CHECK_INTERVAL=5"    # Частая проверка (5 секунд)
set "CHECK_INTERVAL=30"   # Редкая проверка (30 секунд)
```

### Пользовательские типы запуска

Выберите подходящий тип запуска:

```batch
set "SERVICE_STARTUP_TYPE=delayed-auto"  # Рекомендуется для большинства случаев
set "SERVICE_STARTUP_TYPE=auto"          # Непосредственный запуск
set "SERVICE_STARTUP_TYPE=demand"        # Только ручной запуск
```

## Структура файлов

```
project/
├── service_manager.bat          # Основной автоматический монитор
├── start_services.bat           # Ручной запуск служб
├── stop_services.bat            # Ручная остановка служб
├── install_service.bat          # Системная установка
├── uninstall_service.bat        # Удаление из системы
├── check_service_status.bat     # Проверка статуса и диагностика
├── LICENSE     				 # Лицензия
└── README.md                    # Этот файл
```

## Лицензия

Проект лицензирован под MIT License - детали в файле LICENSE.

---

**Совет**: Всегда тестируйте скрипты на не-критичных службах перед использованием. Используйте системную установку для надежной фоновой работы.